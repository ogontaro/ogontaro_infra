version: "3.8"

services:
  traefik:
    image: traefik:v2.3
    container_name: ogontaro_traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      default:
      macvlan:
        ipv4_address: 192.168.18.199
    ports:
      - "80:80"
      - "443:443"
      - "2222:22"
      # The Web UI (enabled by --api.insecure=true)
      - "8080:8080"
    env_file:
      - .env
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./containers/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./containers/traefik/dynamic.yml:/etc/traefik/dynamic.yml
      - ./containers/certs/:/certs/
    labels:
      - traefik.enable=true

  certbot:
    image: certbot/dns-route53
    container_name: certbot
    volumes:
      - ./containers/certs/:/etc/letsencrypt/
    restart: unless-stopped
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --dns-route53 --agree-tos -m ${LETSENCRIPT_REGISTER_EMAIL} -d ogontaro.com -d *.ogontaro.com ; sleep 12h & wait $${!}; done;"
#    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot certonly --dns-route53 --agree-tos -m ${LETSENCRIPT_REGISTER_EMAIL} -d ogontaro.com -d *.ogontaro.com; sleep 12h & wait $${!}; done;"
    env_file:
      - .env

  rancher:
    container_name: ogontaro_rancher
    image: rancher/rancher:v2.4.8
    restart: unless-stopped
    depends_on:
      - traefik
    volumes:
      - ./containers/rancher/volume:/var/lib/rancher
    labels:
      - traefik.enable=true
      - traefik.http.routers.rancher.rule=Host(`rancher.ogontaro.com`)
      - traefik.http.services.rancher.loadbalancer.server.port=80
      - ./containers/certs/:/certs/:/etc/rancher/ssl/

networks:
  macvlan:
    driver: macvlan
    driver_opts:
      parent: eno1
    ipam:
      config:
        - subnet: 192.168.18.0/24
          gateway: 192.168.18.1
